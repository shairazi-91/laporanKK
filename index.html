// Gantikan bahagian logik butang AI dalam kod anda dengan ini:
document.getElementById('btn-ai').onclick = async () => {
    const key = document.getElementById('api_key').value;
    const akt = document.getElementById('in_aktiviti').value;
    
    if(!key) return alert("Sila masukkan API KEY!");
    
    const loading = document.getElementById('ai-loading');
    loading.classList.remove('hidden');

    try {
        // PERHATIKAN: Saya guna /v1/ dan bukan /v1beta/
        const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${key}`;
        
        const prompt = `Berikan cadangan elemen kokurikulum dalam JSON sahaja untuk aktiviti: "${akt}". 
        Hasilkan JSON dengan format: {"kbat": "...", "sivik_nilai": "...", "sivik_sub": "...", "sivik_akt": "...", "pikebm_tajuk": "...", "pikebm_akt": "...", "refleksi": "..."}`;

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
            })
        });

        const result = await response.json();

        // Jika ralat 404 masih keluar, bermakna akaun/key masih bermasalah
        if (result.error) {
            throw new Error(`Ralat dari Google: ${result.error.message}`);
        }

        let aiText = result.candidates[0].content.parts[0].text;
        aiText = aiText.replace(/```json/g, "").replace(/```/g, "").trim();
        const data = JSON.parse(aiText);

        // Isi field MS 2
        document.getElementById('in_kbat').value = data.kbat;
        document.getElementById('in_sivik_nilai').value = data.sivik_nilai;
        document.getElementById('in_sivik_sub').value = data.sivik_sub;
        document.getElementById('in_sivik_akt').value = data.sivik_akt;
        document.getElementById('in_pikebm_tajuk').value = data.pikebm_tajuk;
        document.getElementById('in_pikebm_akt').value = data.pikebm_akt;
        document.getElementById('in_refleksi').value = data.refleksi;

        sync(); // Pastikan fungsi sync() anda dipanggil
        alert("AI Berjaya mengisi MS 2!");
    } catch (e) {
        alert("Kritikal Ralat: " + e.message);
    } finally {
        loading.classList.add('hidden');
    }
};
